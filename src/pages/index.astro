---
import Layout from "../layouts/Layout.astro"
---

<Layout>
    <div id="canvas-container" class="fixed top-0 left-0 w-full h-full -z-10 opacity-40"></div>
    
    <main id="smooth-wrapper">
        <div id="smooth-content">
            <header class="border-b border-b-accent w-full p-6 bg-background/10 backdrop-blur-sm">
                <div class="flex gap-2 items-center">
                    <img src="/favicon.svg" height="200" class="w-10 md:w-14" />
                    <h1 class="text-2xl md:text-4xl bg-clip-text text-transparent bg-linear-to-r from-primary to-secondary [-webkit-text-stroke:0.2px_var(--color-accent)]">Asphal</h1>
                </div>
            </header>

            <br /><br /><br /><br /><br /><br />

            <section class="flex flex-col justify-center items-center gap-3 px-6">
                <h1 class="text-center text-4xl md:text-6xl bg-clip-text text-transparent bg-linear-to-r from-primary to-secondary font-bold tracking-tighter">Proactive Security,<br/> Automated Defense</h1>
                <p class="text-lg md:text-xl text-center w-full md:w-1/2">Asphal is an AI-native cybersecurity startup building autonomous systems that protect modern applications at both the source code and runtime levels.</p>
                <button class="fancy-button">Secure Your Pipeline</button>
            </section>

            <div class="h-[50vh] flex flex-col justify-center items-center"></div>

            <section id="section-two" class="h-screen flex items-center justify-start px-4 md:px-20">
                <div class="flex flex-col gap-3 w-full md:w-1/2 p-8 md:p-12 bg-primary/5 backdrop-blur-xs border-2 border-primary border-dashed hover:border-accent transition-all">
                    <h2 class="text-2xl md:text-4xl font-bold mb-4 text-secondary uppercase">The "Secure" Pipeline is a Myth.</h2>
                    <hr class="border-secondary w-full border-dashed"/>
                    <p class="text-xl md:text-2xl font-medium">90% of breaches exploit known vulnerabilities that were already "cleared" by manual audits.</p>
                </div>
            </section>

            <section id="section-three" class="h-screen flex items-center justify-end px-4 md:px-20">
                <div class="flex flex-col gap-3 w-full md:w-1/2 p-8 md:p-12 bg-secondary/5 backdrop-blur-xs border-2 border-secondary border-dashed hover:border-accent transition-all text-right">
                    <h2 class="text-2xl md:text-4xl font-bold mb-4 text-primary uppercase tracking-tight">Heimdall: Runtime Immunity</h2>
                    <hr class="border-primary w-full border-dashed"/>
                    <p class="text-xl md:text-2xl font-medium">ML-Powered WAF that analyzes traffic at the transport layer to stop zero-days in real-time.</p>
                </div>
            </section>

            <section id="section-four" class="h-screen flex items-center justify-start px-4 md:px-20">
                <div class="flex flex-col gap-3 w-full md:w-1/2 p-8 md:p-12 bg-primary/5 backdrop-blur-xs border-2 border-primary border-dashed hover:border-accent transition-all">
                    <h2 class="text-2xl md:text-4xl font-bold mb-4 text-secondary uppercase tracking-tight">Anteater: Agentic Defense</h2>
                    <hr class="border-secondary w-full border-dashed"/>
                    <p class="text-xl md:text-2xl font-medium">Autonomously discovers, exploits, and remediates source code vulnerabilities before attackers do.</p>
                </div>
            </section>

            <div class="h-[30vh]"></div>
        </div>
    </main>
</Layout>

<script>
import {gsap} from 'gsap';
import { ScrollSmoother } from 'gsap/ScrollSmoother';
import { ScrollTrigger } from 'gsap/ScrollTrigger';
import * as THREE from 'three';

gsap.registerPlugin(ScrollTrigger, ScrollSmoother);

// Initialize Smooth Scroll
ScrollSmoother.create({
    wrapper: '#smooth-wrapper',
    content: '#smooth-content',
    smooth: 1.5,
    effects: true,
    smoothTouch: 1,
});

const container = document.querySelector('#canvas-container') as HTMLDivElement;
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, powerPreference: 'high-performance' });

renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
container.appendChild(renderer.domElement);

const pointLight = new THREE.PointLight(0xffffff, 150);
pointLight.position.set(0, 5, 10);
scene.add(pointLight);

// --- AGGRESSIVE DITHER SHADER ---
const ditherVertex = `
varying vec2 vUv;
varying vec3 vNormal;
void main() {
    vUv = uv;
    vNormal = normalize(normalMatrix * normal);
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`;

const ditherFragment = `
varying vec2 vUv;
varying vec3 vNormal;
uniform vec3 uLightPos; 
uniform vec3 uColor;

float dither(vec2 position, float brightness) {
    vec2 p = floor(position / 2.0); 
    int x = int(mod(p.x, 4.0));
    int y = int(mod(p.y, 4.0));
    float b = floor(brightness * 5.0) / 5.0;
    float limit = 0.0;
    if (x == 0) { if (y == 0) limit = 0.0625; else if (y == 1) limit = 0.5625; else if (y == 2) limit = 0.1875; else limit = 0.6875; }
    else if (x == 1) { if (y == 0) limit = 0.8125; else if (y == 1) limit = 0.3125; else if (y == 2) limit = 0.9375; else limit = 0.4375; }
    else if (x == 2) { if (y == 0) limit = 0.25; else if (y == 1) limit = 0.75; else if (y == 2) limit = 0.125; else limit = 0.625; }
    else { if (y == 0) limit = 1.0; else if (y == 1) limit = 0.5; else if (y == 2) limit = 0.875; else limit = 0.375; }
    return b < limit ? 0.0 : 1.0;
}

void main() {
    vec3 lightDir = normalize(uLightPos); 
    float diffuse = dot(vNormal, lightDir) * 0.5 + 0.5;
    float ditherVal = dither(gl_FragCoord.xy, diffuse);
    gl_FragColor = vec4(uColor * ditherVal, 1.0);
}
`;

// --- OBJECTS ---
const asphalCore = new THREE.Group();
const coreGeo = new THREE.IcosahedronGeometry(20, 2);
const coreMat = new THREE.MeshBasicMaterial({ color: 0xFC8374, wireframe: true, transparent: true, opacity: .15, side: THREE.BackSide });
asphalCore.add(new THREE.Mesh(coreGeo, coreMat), new THREE.Points(coreGeo, new THREE.PointsMaterial({ color: 0xFC8374, size: 0.1 })));
scene.add(asphalCore);

const baseUniforms = { uLightPos: { value: pointLight.position } };

const cubeMesh = new THREE.Mesh(new THREE.TorusKnotGeometry(2, 0.6, 100, 16, 1, 3), new THREE.ShaderMaterial({ vertexShader: ditherVertex, fragmentShader: ditherFragment, uniforms: { ...baseUniforms, uColor: { value: new THREE.Color(0xff2222) } } }));
const octaMesh = new THREE.Mesh(new THREE.TorusKnotGeometry(2, 0.4, 200, 32, 3, 7), new THREE.ShaderMaterial({ vertexShader: ditherVertex, fragmentShader: ditherFragment, uniforms: { ...baseUniforms, uColor: { value: new THREE.Color(0xFECE99) } } }));
const torusMesh = new THREE.Mesh(new THREE.TorusKnotGeometry(2, 0.6, 100, 16), new THREE.ShaderMaterial({ vertexShader: ditherVertex, fragmentShader: ditherFragment, uniforms: { ...baseUniforms, uColor: { value: new THREE.Color(0xFC8374) } } }));

scene.add(cubeMesh, octaMesh, torusMesh);

// --- RESPONSIVE HANDLER ---
let tl: gsap.core.Timeline;

const updateLayout = () => {
    const isMobile = window.innerWidth < 768;
    const xPos = isMobile ? 0 : 10; // On mobile, move shapes toward center
    const xCam = isMobile ? 0 : 5;  // On mobile, keep camera centered
    const zCam = isMobile ? 12 : 8; // On mobile, zoom out slightly

    // Update Mesh Positions
    cubeMesh.position.set(isMobile ? 0 : 9, -6, isMobile ? -2 : 1);
    octaMesh.position.set(isMobile ? 0 : -9, -18, isMobile ? -2 : 1);
    torusMesh.position.set(isMobile ? 0 : 10, -30, isMobile ? -2 : 2);

    // Refresh Timeline
    if (tl) tl.kill();
    tl = gsap.timeline({
        scrollTrigger: {
            trigger: '#section-two',
            start: "top bottom",
            endTrigger: "#section-four",
            end: "bottom bottom",
            scrub: true,
        }
    });

    tl.to(camera.position, { x: xCam, y: -6, z: zCam, duration: 1 })
      .to(camera.position, { x: -xCam, y: -18, z: zCam, duration: 1 })
      .to(camera.position, { x: xCam, y: -30, z: zCam + 2, duration: 1 });
};

updateLayout();

// --- ANIMATION ---
camera.position.set(0, 0, 0);
gsap.to(asphalCore.rotation, { y: Math.PI * 2, duration: 50, repeat: -1, ease: "none" });
[cubeMesh, octaMesh, torusMesh].forEach(m => {
    gsap.to(m.rotation, { y: Math.PI * 2, x: Math.PI, duration: 15, repeat: -1, ease: "none" });
});

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    updateLayout();
    ScrollTrigger.refresh();
});

function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}
animate();
</script>
